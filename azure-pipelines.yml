trigger:
- main

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Build

    jobs: 
    - job : Build
    
      steps:
      - task: SonarCloudPrepare@1
        inputs:
          SonarCloud: 'SonarCloud'
          organization: 'jannotjarks'
          scannerMode: 'MSBuild'
          projectKey: 'JannoTjarks_E-Paper'
          projectName: 'E-Paper'

      - task: DotNetCoreCLI@2
        inputs:
          command: 'restore'
          feedsToUse: 'select'

      - task: DotNetCoreCLI@2
        inputs:
          command: 'build'

      - task: SonarCloudAnalyze@1

      - task: DotNetCoreCLI@2
        inputs:
          command: 'publish'
          publishWebProjects: true
          arguments: '--output $(Build.ArtifactStagingDirectory)'
          zipAfterPublish: false
          
      - task: PublishBuildArtifacts@1
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)'
          ArtifactName: 'drop'
          publishLocation: 'Container'
  
  - stage: Deploy

    jobs:
      - deployment: Production
        displayName: Production
        environment: Production
      
        variables:
        - group: 'Production Settings'
        
        strategy:
            runOnce:
                deploy:
                    steps:
                    - task: SSH@0
                      displayName: 'Stop Service e-paper-api'
                      inputs:
                        sshEndpoint: 'root@jtjarks.de'
                        commands: 'systemctl stop e-paper-api.service'
                    - task: CopyFilesOverSSH@0
                      displayName: 'Securely copy files to the remote machine'
                      inputs:
                        sshEndpoint: 'root@jtjarks.de'
                        sourceFolder: '$(System.DefaultWorkingDirectory)/_JannoTjarks.E-Paper-API/drop/a'
                        targetFolder: '/opt/e-paper-api/'
                        cleanTargetFolder: true
                    - task: SSH@0
                      displayName: 'Start Service e-paper-api'
                      inputs:
                        sshEndpoint: 'root@jtjarks.de'
                        commands: 'systemctl start e-paper-api.service'

